# 问题分析

用于记录课题开发与调试中出现的问题分析

---

### 1. 环境配置问题
- Keil误装乘C51版本，重装后解决。
问题描述：Keil按流程破解后仍显示失败。
解决：安装C51版本后解决。
问题分析：C51版本与ARM版本不兼容。

### 2. 超声波传感器安装
问题描述：超声波传感器一开始的安装与控制板位置有冲突。
解决：微调控制板位置，腾出空间，成功安装上。
问题分析：超声波传感器安装位置与控制板位置有冲突，导致安装不成功。

### 3. 红外光电模块中传感器区分
问题描述：红外模块示例代码中a,b,c,d数值与红外传感器从左至右的位置不对应。
解决：调整代码中a,b,c,d数值，使其与红外传感器从左至右的位置对应。
问题分析：
最开始的读取传感器数据程序如下：
```c
Car_sensor.a = Read_sensor(sensor1);
···
```
但是实际运行程序时发现a,b,c,d数值与红外传感器从左至右的位置不对应。我们通过每次只遮挡一个传感器，观察数值变化，确立对应关系，最终解决。最后的对应关系为a,b,c,d-->2,3,4,1


问题描述：红外传感器在不同赛道上输出不同。
解决：修改代码，使结果输出与赛道对应。
问题分析：
在桌子上测试时，传感器检测到黑线亮起。但是在地上某赛道（有Tsinghua终点标识）传感器检测到黑线灭掉。导致传感器a,b,c,d数值0/1相反。最终我们对程序做出如下改动解决：
```c
Car_sensor.a = 1 - Read_sensor(sensor1); 
···
```
### 4. 电机驱动的对应问题
问题描述：软件中电机顺序与硬件中电机顺序不对应。
解决：软件中依次使三个电机只转动一个，找到对应关系。
问题分析：开始误以为编码器控制的是电机控制部分的电机顺序，后来发现是电机编码器（读取）的顺序（改接线发现电机转法不变）。用软件次使三个电机只转动一个，找到了对应关系。编码器同理。

### 5. 光电循迹中红外光电对于赛道识别
问题描述：红外传感器本身数量较少只有四个，且工作效果不好。
解决：采用pid控制+调参解决。
问题分析：传感器较少且阈值不易调节。当传感器在黑线（蓝色背景赛道，有THU标识）调节到刚好灭灯时，把小车放置蓝底却不再亮起，反之亦然。这对程序的鲁棒性提出挑战，我们采用pid控制+调参解决。

### 6. 赛道识别问题和转弯问题
问题描述：赛道识别存在大量弯曲，直角弯等情况，示例程序不再适用。
解决：小车正常状态下直行，传感器好比“触角”，左边触角触到道路边界，小车停止前行，原地右转，反之亦然。
问题分析：直角弯、锐角弯易与“陷阱”混淆，不采取试探方法可能导致小车冲出弯道或识别不出“陷阱”。我们让小车左右试探以寻找出口，可以增强小车对不同场景的识别能力。

### 7. 如何避开“陷阱”
问题描述：小车在遇到“陷阱”时，难以识别并准确越过。
解决：小车左右试探寻找出口。
问题分析：
“陷阱”易与直角弯、锐角弯等情况混淆，采取下述方法可以较精确地识别“陷阱”并准确越过。
当传感器识别到四个黑色信号时，开始寻找出口。小车先向左转约90度寻找出口，若不是全黑，则状态变成前进；否则小车略微后退，若没遇到全黑，则状态变成前进，否则小车改为右转约180度。右转后采取与左转后相同的办法检测右侧是否有出口，若有，则状态变成前进，否则状态变成回正，回正后状态变成冲刺，冲过“陷阱”，冲过后状态变成前进。小车略微后退是为了放置小车探头转到赛道外而冲出赛道。

### 8. 超声波避障
问题描述：在car_tim()中调用Get_Distance()会失效。
解决：按照实例将Get_Distance()函数留在OLED_Task中。
问题分析：调用Get_Distance()函数获取超声测得距离，后续测试发现此函数放在car_tim()中会失效，故按照实例留在OLED_Task中。具体为什么尚不清楚。

### 9. 走迷宫——思路、问题与解决方法
基本思路就是小车只要贴着左墙/右墙走，只要迷宫有解，必然走出迷宫。

这里面有三个基本问题：

1. 小车如何在正常情况下既不会撞墙，又不会离开。<br>
解决办法：小车左侧传感器检测距离，小了就轻微右转，大了再轻微左转。

2. 小车如何在面壁后右转。<br>
解决办法：小车前方传感器检测距离，如果足够小了，就进入右转状态，小车直接右转约90度。

3. 小车如何在丢失左侧墙壁检测后掉头。<br>
解决办法：左侧传感器如果检测到左方距离很大，就认为丢失。进入左转状态，左转90度左右并前行一小段距离。

这三个函数由状态机统一控制。

### 10. Control()函数的添加（目前尚未清楚原因）
问题描述：程序在Control()函数中运行失效。
解决：将Control()函数中的内容复制到Car_tim()中，将Control()函数写成空函数。
问题分析：尚不清楚。

### 11. OpenMV IDE版本问题
问题描述：OpenMV IDE版本问题。
解决：刷机并且使用低版本IDE并保证板子上固件也为低版本。
问题分析：
罄竹难书！一言难尽！不言而喻！

由于旧版本IDE无法连接板子，我们队伍最初的OpenMV使用的是Github上的4.7.0。

- 刷写高版本固件时，出现了引脚不存在的错误。这是因为新版固件会自动更新引脚配置，但本次实验使用的固件包含了非官方引脚，导致系统无法识别。

- 在高版本运行后，在低版本运行会出现找不到摄像头的相关错误，具体原因还是高版本运行时会自动更新固件

---
之所以使用新版，原因是因为使用课程给的旧版文件时，连接电脑与LQ_MV4模块时出现报错：
```
错误：系统找不到指定的路径！
```

这一报错与软件安装路径无关，解决办法是在快捷方式打开属性，在目标一栏对应的路径后添加 -update resources（有空格），[详细教程](https://blog.csdn.net/weixin_45479272/article/details/144615295?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522602fee533f97966eac532088a73a2fb5%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=602fee533f97966eac532088a73a2fb5&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-144615295-null-null.14)

### 12. 串口传输：
问题描述：LQ_Usart.c中USART3_Handler变量无法被外部代码调用。
解决：在LQ_Usart.c中添加一个输出到USART3端口的函数，使其可以被外部代码调用。
问题分析：示例代码中，USART3_Handler是LQ_Usart.c中的变量，无法作为全局变量被主函数调用。为LQ_Usart.c添加一个输出到USART3端口的函数，再由主函数调用即可。

### 13. 模板匹配：
问题描述：灰度图与彩图同时获取。
解决：先获取彩图，再用图像类的to_grayscale()函数转换为灰度图。
问题分析：模板匹配只用到灰度图，故先读取彩图，再转换成灰度图。


### 14. 视觉避障
问题描述：使用单一方法不易识别到箱子。
解决：结合颜色识别和模板匹配两种方法，识别后对两种识别结果求交，求交结果面积大于模板匹配面积70%时判定为识别到。
问题分析：
最开始只使用颜色识别的方法，发现颜色识别误差较大，经常识别到除箱子以外的区域（例如腿和桌子）。考虑使用模板匹配方法，但是箱子特征很少，且模板匹配使用灰度图，容易识别到赛道的蓝色背景。幸运的是两个误识别的区域不相交。故结合两种方法，识别后对两种识别结果求交，求交结果面积大于模板匹配面积70%时判定为识别到。

### 15.寻找红球
问题描述：寻找红球时小车摇摆，易拨走红球。
解决：在小车识别到足够大且且在中心位置的红球后，小车向红球前进。
问题分析：在出岔路之前，小车还处于循线状态，小车频于摇摆，易将红球拨开。所以在红球足够大且且在中心位置时，认为找到了红球，小车向红球追去。小车进入cruise状态。行进过程中，若没有看到箭头，则使小车追随红球，保证红球始终在推子内。

### 17.编码器
问题描述：无法理解编码器输出的意思。
解决：放弃。
问题分析：提起小车使轮子空转时，编码器与车的速度有较好对应关系。但小车在地上时，编码器左右轮转速为零时示数是-10，有速度后，左轮示数往下掉，右轮示数往上涨，且两边倍率不一样，无法明确了解左右轮转速和编码器输出之间的关系，遂放弃。建议厂商给出编码器的详细使用说明。

### 18.推子
问题描述：推子遮挡光线使红外误判。
解决：换新推子。
问题分析：旧推子是3D打印的，容易遮挡光线使红外误判。新推子虽然简陋，但不会遮挡光线。

### 19.蓝牙
问题描述：蓝牙模块编码解码混乱。
解决：虽然编码解码混乱，但发现不同按键会对应不同消息，依次区分上下左右四个按键。
问题分析：接法端两边编码解码方式很离奇，发送完双方都互相接收到神秘字符。还好手机app里摁下不同键后电脑收到的不一样，可以由此区分按键。键按下后，使小车依照键的信息跑2000次，由此成功遥控小车。